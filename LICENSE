"""
Apache License 2.0

Copyright 2025 ekstezens

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
"""

import json
import hashlib
from datetime import datetime
from typing import Optional, Dict, Any, List
from dataclasses import dataclass
import logging

logger = logging.getLogger(__name__)

@dataclass
class LicenseInfo:
    """Информация о лицензии Apache 2.0"""
    copyright: str = "Copyright 2025 ekstezens"
    license: str = "Apache-2.0"
    disclaimer: str = "See NOTICE file for additional notices"
    
class ApacheLicensedComponent:
    """
    Пример компонента с Apache License 2.0
    
    Все права и ограничения применяются согласно лицензии.
    Компонент демонстрирует корректное оформление кода под Apache 2.0.
    """
    
    VERSION = "1.0.0"
    LICENSE_URL = "http://www.apache.org/licenses/LICENSE-2.0"
    
    def __init__(self, component_name: str):
        """
        Инициализация лицензированного компонента
        
        Args:
            component_name: Название компонента
        """
        self.component_name = component_name
        self.created = datetime.now()
        self.license_info = LicenseInfo()
        
    def generate_notice(self) -> str:
        """
        Генерация уведомления о лицензии Apache 2.0
        
        Returns:
            Форматированное уведомление
        """
        notice = f"""{self.license_info.copyright}

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this component except in compliance with the License.
You may obtain a copy of the License at

    {self.LICENSE_URL}

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

Component: {self.component_name}
Version: {self.VERSION}
Created: {self.created.isoformat()}
"""
        return notice
    
    def process_data(self, data: Dict[str, Any]) -> Dict[str, Any]:
        """
        Обработка данных с проверкой лицензионных ограничений
        
        Args:
            data: Входные данные
            
        Returns:
            Обработанные данные
            
        Raises:
            ValueError: Если данные не соответствуют требованиям
        """
        if not data:
            raise ValueError("Data cannot be empty")
            
        # Добавляем информацию о лицензии в результат
        result = {
            "data": data,
            "metadata": {
                "processed_by": self.component_name,
                "license": self.license_info.license,
                "timestamp": datetime.now().isoformat(),
                "copyright": self.license_info.copyright
            }
        }
        
        logger.info(f"Data processed under {self.license_info.license}")
        return result
    
    @staticmethod
    def verify_license_compliance(source_files: List[str]) -> bool:
        """
        Проверка соответствия файлов требованиям Apache 2.0
        
        Args:
            source_files: Список путей к файлам
            
        Returns:
            True если все файлы содержат уведомление о лицензии
        """
        required_texts = [
            "Apache License",
            "Copyright",
            "http://www.apache.org/licenses/LICENSE-2.0"
        ]
        
        for file_path in source_files:
            try:
                with open(file_path, 'r', encoding='utf-8') as f:
                    content = f.read()
                    for text in required_texts:
                        if text not in content:
                            logger.warning(f"Missing '{text}' in {file_path}")
                            return False
            except Exception as e:
                logger.error(f"Error reading {file_path}: {e}")
                return False
                
        return True

class ExtendedComponent(ApacheLicensedComponent):
    """
    Расширенный компонент, наследуемый от ApacheLicensedComponent
    
    Наследует все лицензионные ограничения Apache 2.0
    """
    
    def __init__(self, component_name: str, author: str = "ekstezens"):
        super().__init__(component_name)
        self.author = author
        self.contributors = []
        
    def add_contributor(self, name: str, year: int = 2025):
        """
        Добавление контрибьютора с сохранением информации о правах
        
        Args:
            name: Имя контрибьютора
            year: Год внесения вклада
        """
        contributor_info = {
            "name": name,
            "year": year,
            "added": datetime.now().isoformat()
        }
        self.contributors.append(contributor_info)
        
    def generate_extended_notice(self) -> str:
        """
        Генерация расширенного уведомления с информацией о контрибьюторах
        """
        base_notice = self.generate_notice()
        
        contributors_section = "\nContributors:\n"
        for contrib in self.contributors:
            contributors_section += f"- {contrib['name']} ({contrib['year']})\n"
            
        return base_notice + contributors_section

# Пример использования
def main():
    """Пример использования лицензированных компонентов"""
    
    # Создаем компонент с Apache License 2.0
    component = ApacheLicensedComponent("DataProcessor")
    
    # Выводим уведомление о лицензии
    print("=== LICENSE NOTICE ===")
    print(component.generate_notice())
    print("======================")
    
    # Обрабатываем данные
    sample_data = {"key": "value", "test": 123}
    processed = component.process_data(sample_data)
    
    print(f"\nProcessed data with metadata:")
    print(json.dumps(processed, indent=2))
    
    # Пример с расширенным компонентом
    extended = ExtendedComponent("AdvancedProcessor", "ekstezens")
    extended.add_contributor("John Doe", 2025)
    extended.add_contributor("Jane Smith", 2025)
    
    print(f"\nExtended component notice:")
    print(extended.generate_extended_notice())
    
    # Проверка соответствия лицензии
    print(f"\nLicense compliance check:")
    # В реальном проекте здесь был бы список файлов проекта
    # compliance = component.verify_license_compliance(["file1.py", "file2.py"])

if __name__ == "__main__":
    main()
